<html>
<body>
<a href="../djb.html">D. J. Bernstein</a>
<br><a href="../unix.html">UNIX</a>
<br><a href="../daemontools.html">daemontools</a>
<h1>The multilog program</h1>
<tt>multilog</tt>
reads a sequence of lines from stdin
and appends selected lines to any number of logs.
<h2>Interface</h2>
<pre>
     multilog <i>script</i>
</pre>
<tt><i>script</i></tt>
consists of any number of arguments.
Each argument specifies one action.
The actions
are carried out in order for each line of input.
Note that actions may contain shell metacharacters that need to be quoted
when <tt>multilog</tt> is run from a shell.
<p>
<tt>multilog</tt>
exits 0 when it sees the end of stdin.
If stdin has a partial final line
then <tt>multilog</tt>
inserts a final newline.
<p>
<tt>multilog</tt>
writes a message to stderr and exits 111, without reading any input,
if it runs out of memory or if another <tt>multilog</tt> process
is writing to one of the same automatically rotated logs.
<p>
If <tt>multilog</tt>
has trouble writing to disk after it starts reading input,
it writes a message to stderr, pauses, and tries again,
without losing any data.
Note that this may block any program feeding input to <tt>multilog</tt>.
<p>
If <tt>multilog</tt>
receives a TERM signal,
it will read and process data until the next newline,
and then exit,
leaving stdin at the first byte of data it has not processed.
<h2>Selecting lines</h2>
Each line is initially selected.
The action
<pre>
     -<i>pattern</i>
</pre>
deselects the line if <tt><i>pattern</i></tt> matches the line.
The action
<pre>
     +<i>pattern</i>
</pre>
selects the line if <tt><i>pattern</i></tt> matches the line.
<p>
<tt><i>pattern</i></tt> is a string of stars and non-stars.
It matches any concatenation of strings
matched by all the stars and non-stars in the same order.
A non-star matches itself.
A star before the end of <tt><i>pattern</i></tt> matches any string
that does <i>not</i> include
the next character in <tt><i>pattern</i></tt>.
A star at the end of <tt><i>pattern</i></tt> matches any string.
<p>
For example, the action
<pre>
     +hello
</pre>
selects <tt>hello</tt>.
It does not select <tt>hello world</tt>.
<p>
The action
<pre>
     -named[*]: Cleaned cache *
</pre>
deselects <tt>named[135]: Cleaned cache of 3121 RRs</tt>.
The first star matches any string that does not include
a right bracket.
<p>
The action
<pre>
     -*
</pre>
deselects every line.
<p>
To save memory,
<tt>multilog</tt> actually checks <tt><i>pattern</i></tt> against
only the first 1000 characters of each line.
<h2>Alerts</h2>
The action
<pre>
     e
</pre>
prints (the first 200 bytes of) each selected line to stderr.
<h2>Status files</h2>
The action
<pre>
     =<i>file</i>
</pre>
replaces the contents of <tt><i>file</i></tt>
with (the first 1000 bytes of) each selected line,
padded with newlines to 1001 bytes.
There is no protection of <tt><i>file</i></tt> against power outages.
<p>
For example, the sequence of actions
<pre>
     -*
     +STAT*
     =log/status
</pre>
maintains <tt>log/status</tt>
as a copy of the most recent line starting with <tt>STAT</tt>.
<h2>Timestamping</h2>
The action
<pre>
     t
</pre>
inserts an @, a precise timestamp, and a space in front of each line,
using the same format as <a href="tai64n.html">tai64n</a>.
This is required to be the first action.
Patterns apply to the line after the timestamp is inserted.
<p>
You can use
<a href="tai64nlocal.html">tai64nlocal</a>
to convert these timestamps to human-readable form.
<h2>Automatically rotated logs</h2>
If <tt><i>dir</i></tt>
starts with a dot or slash then the action
<pre>
     <i>dir</i>
</pre>
appends each selected line to a log named <tt><i>dir</i></tt>.
If <tt><i>dir</i></tt> does not exist, <tt>multilog</tt> creates it.
<p>
The log format is as follows.
<tt><i>dir</i></tt> is a directory containing
some number of old log files,
a log file named <tt>current</tt>,
and other files for <tt>multilog</tt> to keep track of its actions.
Each old log file has a name beginning with @,
continuing with a precise timestamp
showing when the file was finished,
and ending with one of the following codes:
<ul>
<li><tt>.s</tt>: This file is completely processed and safely written to disk.
<li><tt>.u</tt>: This file was being created at the moment of an outage.
It may have been truncated and has not been processed.
</ul>
Beware that NFS, async filesystems, and softupdates filesystems
may discard files that were not safely written to disk before an outage.
<p>
While <tt>multilog</tt> is running,
<tt>current</tt> has mode 644.
If <tt>multilog</tt> sees the end of stdin,
it writes <tt>current</tt> safely to disk,
and sets the mode of <tt>current</tt> to 744.
When it restarts, it sets the mode of <tt>current</tt> back to 644
and continues writing new lines.
<p>
When <tt>multilog</tt> decides that <tt>current</tt> is big enough,
it writes <tt>current</tt> safely to disk,
sets the mode of <tt>current</tt> to 744,
and renames <tt>current</tt> as an old log file.
<p>
The action
<pre>
     s<i>size</i>
</pre>
sets the maximum file size
for subsequent <tt><i>dir</i></tt> actions.
<tt>multilog</tt> will decide that <tt>current</tt> is big enough
if <tt>current</tt> has <tt><i>size</i></tt> bytes.
(<tt>multilog</tt>
will also decide that <tt>current</tt> is big enough
if it sees a newline within 2000 bytes of the maximum file size;
it tries to finish log files at line boundaries.)
<tt><i>size</i></tt> must be between 4096 and 16777215.
The default maximum file size is 99999.
<p>
The action
<pre>
     n<i>num</i>
</pre>
sets the number of log files
for subsequent <tt><i>dir</i></tt> actions.
After renaming <tt>current</tt>,
if <tt>multilog</tt> sees <tt><i>num</i></tt> or more old log files,
it removes the old log file with the smallest timestamp.
<tt><i>num</i></tt> must be at least 2.
The default number of log files is 10.
<p>
The action
<pre>
     !<i>processor</i>
</pre>
sets a processor for subsequent <tt><i>dir</i></tt> actions.
<tt>multilog</tt> will feed <tt>current</tt> through <tt><i>processor</i></tt>
and save the output as an old log file instead of <tt>current</tt>.
<tt>multilog</tt> will also save any output that <tt><i>processor</i></tt>
writes to descriptor 5,
and make that output readable on descriptor 4
when it runs <tt><i>processor</i></tt> on the next log file.
For reliability, <tt><i>processor</i></tt> must exit nonzero
if it has any trouble creating its output;
<tt>multilog</tt> will then run it again.
Note that running <tt><i>processor</i></tt>
may block any program feeding input to <tt>multilog</tt>.
</body>
</html>
