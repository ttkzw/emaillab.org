<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
<title>The multilog program</title>
</head>
<body>
<a href="http://cr.yp.to/djb.html">D. J. Bernstein</a>
<br><a href="http://cr.yp.to/unix.html">UNIX</a>
<br><a href="top.html">daemontools</a>
<h1><a href="http://cr.yp.to/daemontools/multilog.html">multilog プログラム</a></h1>
<tt>multilog</tt> は標準入力から一続きの行を読み、任意の数のログに選択された行を追加します。

<h2>使い方</h2>
<pre>
     multilog <i>script</i>
</pre>
<tt><i>script</i></tt> はいくつかの引数から成ります。
各引数は一つの動作を明記します。
その動作は入力の各行の順に実行されます。
<tt>multilog</tt> がシェルから起動されるとき、動作は引用符で囲まれる必要があるシェルのメタキャラクタを含めてもよいことに注意してください。

<p>
標準入力の終りに達すると <tt>multilog</tt> はコード0で終了します。
標準入力の最終行に改行がなければ、<tt>multilog</tt> は改行を挿入します。

<p>
メモリ不足が起きたときや、 別の <tt>multilog</tt> プロセス がすでに同じ自動切り替えのログに書いているときには、入力を読むのをやめ、標準エラーにメッセージを書き出して、コード111で終了します。 

<p>
いったん入力を読み始めたあとにディスクへの出力でトラブルがあると、
<tt>multilog</tt> は標準エラーにメッセージを書いて、休止し、再度試みます。
データが失われることはありません。
これにより<tt>multilog</tt>の入力を生成している側のプロセスがブロックされることになるかもしれないことに注意してください。

<p>
<tt>multilog</tt> は TERM シグナルを受け取ると、データを次の改行コードまで読み込んで処理したあと、終了します。
このとき、標準入力はまだ処理されていないデータの先頭を指しています。

<h2>行の選択指定</h2>
各行は最初は選択されています。
動作
<pre>
     -<i>pattern</i>
</pre>
は <tt><i>pattern</i></tt> が行に合えばその行の選択が解除されます。
動作
<pre>
     +<i>pattern</i>
</pre>
は <tt><i>pattern</i></tt> が行に合えばその行は選択されます。

<p>
<tt><i>pattern</i></tt>は * とそれ以外からなる文字列です。
それは同じ順番で全ての * とそれ以外の文字に合う文字列をつなぎ合わせたものに合います。
* でない文字は文字自身に合います。
<tt><i>pattern</i></tt> の最後ではない *  は <tt><i>pattern</i></tt> で直後に現れる文字を含まない任意の文字列に合います。
<tt><i>pattern</i></tt> の最後にある * は任意の文字列に合います

<p>
例えば、動作
<pre>
     +hello
</pre>
は <tt>hello</tt> を選択します。
<tt>hello world</tt> は選択しません。

<p>
動作
<pre>
     -named[*]: Cleaned cache *
</pre>
は <tt>named[135]: Cleaned cache of 3121 RRs</tt> の選択を解除します。
最初の * は ] を含まない任意の文字列に合います。

<p>
動作
<pre>
     -*
</pre>
は全ての行の選択を解除します。

<p>
メモリを消耗しないように、実際には <tt>multilog</tt> は各行の最初の 1000 文字のみに対して <tt><i>pattern</i></tt> を調べます。


<h2>警告</h2>
動作
<pre>
     e
</pre>
は標準エラーに選択された各行（の最初の200バイト）を出力します。

<h2>Status ファイル</h2>
動作
<pre>
     =<i>file</i>
</pre>
は <tt><i>file</i></tt> の中身を選択された各行（の最初の1000バイト）で置き換えます。このとき、足らない部分を 1001 バイトまで改行コードで埋めます。
電源断に対しては <tt><i>file</i></tt> は保護されません。

<p>
例えば、一続きの動作
<pre>
     -*
     +STAT*
     =log/status
</pre>
は <tt>STAT</tt> で始まる最新の行のコピーとして <tt>log/status</tt> を維持します。

<h2>タイムスタンプ</h2>
動作
<pre>
     t
</pre>
は各行の先頭に @ と正確なタイムスタンプとスペースを挿入します。これは <a href="tai64n.html">tai64n</a> と同じ形式を用いています。
これは最初の動作にだけ必要とされます。
タイムスタンプが挿入された後に、パターンが行に適応されます。

<p>
<a href="tai64nlocal.html">tai64nlocal</a> を使って、そのタイムスタンプを人が読める形式に変換できます。


<h2>ログの自動切り替え</h2>
<tt><i>dir</i></tt> がドットやスラッシュで始まっていれば、動作
<pre>
     <i>dir</i>
</pre>
はログ <tt><i>dir</i></tt> へ選択された行を追加します。
<tt><i>dir</i></tt> が存在しなければ、<tt>multilog</tt> は作成します。

<p>
ログの形式は以下の通りです。
<tt><i>dir</i></tt> はディレクトリです。古いログファイル郡とログファイル <tt>current</tt> と <tt>multilog</tt> がその動作の記録するための他のファイルがあります。
古いログファイルの名前は @ で始まり、そのファイルがいつ終了したのかを示す正確なタイムスタンプがそれに続き、次のようなコードの一つを付けて終ります。
<ul>
<li><tt>.s</tt>: このファイルは完全に処理され、安全にディスクに書かれている。
<li><tt>.u</tt>: このファイルは電源切断時に作成された。途中で切られているかもしれない。処理が終っていない。
</ul>
NFS や async ファイルシステムや softupdates ファイルシステムは電源切断前にディスクに安全に書き込まれなかったファイルを捨てるかも知れまないことに気をつけてください。

<p>
<tt>multilog</tt> が動いている間は、<tt>current</tt> のモードは 644 です。
<tt>multilog</tt> は標準入力の終りに達したら、 <tt>current</tt> を安全にディスクに書き込み、<tt>current</tt> のモードを 744 に設定します。
再起動したとき、<tt>current</tt> のモードは 644 に戻され、新しい行を書き続けます。

<p>
<tt>multilog</tt> は <tt>current</tt> が十分大きいと判断したら、<tt>current</tt> を安全にディスクに書き込み、<tt>current</tt> のモードを 744 に設定し、<tt>current</tt> を古いログファイルとして名前を変えます。

<p>
動作
<pre>
     s<i>size</i>
</pre>
は続いて記述される動作 <tt><i>dir</i></tt> の最大ファイルサイズを設定します。
<tt>multilog</tt> は <tt>current</tt> が <tt><i>size</i></tt> バイトであれば、十分大きいと判断します。
(<tt>multilog</tt> は最大ファイルサイズの最後の 2000 バイト以内に改行コードがあれば、十分大きいと判断します。行の境目でログファイルを終らせようと試みるためです。)
<tt><i>size</i></tt> は 4096 と 16777215 の間でなければなりません。
デフォルトの最大ファイルサイズは 99999 です。

<p>
動作
<pre>
     n<i>num</i>
</pre>
は続いて記述される動作 <tt><i>dir</i></tt> のログファイルの数を設定します。
<tt>current</tt> の名前を変えた後に、<tt><i>num</i></tt> 個以上の古いログファイルがあれば、<tt>multilog</tt> は最小のタイムスタンプが付いている古いログファイルを削除します。
<tt><i>num</i></tt> は 2 以上でなければなりません。
デフォルトのログファイルの数は 10 です。

<p>
動作
<pre>
     !<i>processor</i>
</pre>
は続いて記述される動作 <tt><i>dir</i></tt> で使うプロセッサを設定します。
<tt>multilog</tt> は <tt><i>processor</i></tt> を通して <tt>current</tt> にデータを与え、<tt>current</tt> の代わりに古いログファイルとして出力を保存します。
<tt>multilog</tt> は <tt><i>processor</i></tt> が記述子 5 に書き出すどんな出力も保存し、<tt><i>processor</i></tt> を次のログファイルで動かしたときに その出力を記述子 4 で読めるようにします。
信頼性のために、<tt><i>processor</i></tt> はその出力を作成するときに問題が生じたら 0 でないコードで終了しなければなりません。<tt>multilog</tt> は再びそれを起動させます。
<tt><i>processor</i></tt> を動かすことは <tt>multilog</tt> に入力を与えるプログラムを止めてしまうかも知れないことに注意してください。
<br>
(訳注：この段落の訳はかなり怪しいです。訳者自身もその動作を理解できていません。原文を読んでください。)

<hr>
訳：滝澤 隆史<br>
（Version 0.61 における前野 年紀 氏による訳をベース）<br>
<!-- hhmts start -->
Last modified: Sat May  6 22:04:51 2000
<!-- hhmts end -->
</body>
</html>
