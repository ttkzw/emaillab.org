<html>
<body>
<a href="../djb.html">D. J. Bernstein</a>
<br><a href="../tcpip.html">TCP/IP</a>
<br><a href="../ucspi-tcp.html">ucspi-tcp</a>
<h1>The <tt>rblsmtpd</tt> program</h1>
<tt>rblsmtpd</tt> blocks mail from RBL-listed sites.
It works with any SMTP server that can run under
<a href="tcpserver.html"><tt>tcpserver</tt></a>.
<h2>Interface</h2>
<pre>
     rblsmtpd <i>opts</i> <i>prog</i>
</pre>
<tt><i>opts</i></tt>
is a series of <tt>getopt</tt>-style options.
<tt><i>prog</i></tt>
consists of one or more arguments.
<p>
Normally <tt>rblsmtpd</tt> runs <tt><i>prog</i></tt>.
<tt><i>prog</i></tt> is expected to carry out an SMTP conversation
to receive incoming mail messages.
<p>
However, <tt>rblsmtpd</tt> does not invoke <tt><i>prog</i></tt>
if it is told to block mail from this client.
Instead it carries out its own limited SMTP conversation,
temporarily rejecting all attempts to send a message.
Meanwhile it prints one line on descriptor 2 to log its activity.
<p>
<tt>rblsmtpd</tt> drops the limited SMTP conversation
after 60 seconds,
even if the client has not quit by then.
<p>
Options:
<ul>
<li><tt>-t <i>n</i></tt>:
Change the timeout to <tt><i>n</i></tt> seconds.
</ul>
<h2>Blocked clients</h2>
If the <tt>$RBLSMTPD</tt> environment variable is set and is nonempty,
<tt>rblsmtpd</tt> blocks mail.
It uses <tt>$RBLSMTPD</tt> as an error message for the client.
Normally <tt>rblsmtpd</tt> runs under
<a href="tcpserver.html"><tt>tcpserver</tt></a>;
you can use
<a href="tcprules.html"><tt>tcprules</tt></a>
to set <tt>$RBLSMTPD</tt> for selected clients.
<p>
If <tt>$RBLSMTPD</tt> is set and is empty,
<tt>rblsmtpd</tt> does not block mail.
<p>
If <tt>$RBLSMTPD</tt> is not set,
<tt>rblsmtpd</tt> looks up <tt>$TCPREMOTEIP</tt> in the RBL,
and blocks mail if <tt>$TCPREMOTEIP</tt> is listed.
<tt>tcpserver</tt> sets up <tt>$TCPREMOTEIP</tt>
as the IP address of the remote host.
<p>
Options:
<ul>
<li><tt>-r <i>base</i></tt>:
Use <tt><i>base</i></tt> as an RBL source.
An IP address <tt><i>a</i>.<i>b</i>.<i>c</i>.<i>d</i></tt>
is listed by that source if
<tt><i>d</i>.<i>c</i>.<i>b</i>.<i>a</i>.<i>base</i></tt>
has a TXT record.
<tt>rblsmtpd</tt> uses the contents of the TXT record
as an error message for the client.
<li><tt>-a <i>base</i></tt>:
Use <tt><i>base</i></tt> as an anti-RBL source.
An IP address <tt><i>a</i>.<i>b</i>.<i>c</i>.<i>d</i></tt>
is anti-listed by that source if
<tt><i>d</i>.<i>c</i>.<i>b</i>.<i>a</i>.<i>base</i></tt>
has an A record.
In this case <tt>rblsmtpd</tt> does not block mail.
</ul>
<p>
You may supply any number of <tt>-r</tt> and <tt>-a</tt> options.
<tt>rblsmtpd</tt> tries each source in turn
until it finds one that lists or anti-lists <tt>$TCPREMOTEIP</tt>.
It also tries an RBL source of <tt>rbl.maps.vix.com</tt>
if you do not supply any <tt>-r</tt> options.
<h2>RBL sources</h2>
If you want to run your own RBL source or anti-RBL source for <tt>rblsmtpd</tt>,
you can use
<a href="../djbdns/rbldns.html">rbldns</a>
from the djbdns package.
<p>
I've heard about the following public RBL sources:
<ul>
<li><tt>blackholes.mail-abuse.org</tt> or <tt>rbl.maps.vix.com</tt>
<li><tt>dialups.mail-abuse.org</tt> or <tt>dul.maps.vix.com</tt>
<li><tt>relays.msci.memphis.edu</tt> or <tt>relays.mail-abuse.org</tt> or <tt>rss.maps.vix.com</tt>
<li><tt>relays.orbs.org</tt>
</ul>
<tt>relays.mail-abuse.org</tt> and <tt>rss.maps.vix.com</tt>
stopped working with <tt>rblsmtpd</tt> in August 2000,
because all the TXT records were removed.
``They were eliminated because the zone file is growing rather large,''
the maintainers said.
This problem wouldn't occur with <tt>rbldns</tt>,
because <tt>rbldns</tt> databases are much smaller than zone files.
However, the people who run MAPS also have financial interests in BIND,
and they refuse to use <tt>rbldns</tt>.
<h2>Temporary errors</h2>
Normally,
if <tt>$RBLSMTPD</tt> is set,
<tt>rblsmtpd</tt> uses a 451 error code
in its limited SMTP conversation.
This tells legitimate clients to try again later.
It gives innocent relay operators
a chance to see the problem,
prohibit relaying,
get off the RBL,
and get the mail delivered.
<p>
However, if <tt>$RBLSMTPD</tt> begins with a hyphen,
<tt>rblsmtpd</tt> removes the hyphen
and uses a 553 error code.
This tells legitimate clients to bounce the message immediately.
<p>
There are several error-handling options for RBL lookups:
<ul>
<li><tt>-B</tt>:
(Default.)
Use a 451 error code for IP addresses listed in the RBL.
<li><tt>-b</tt>:
Use a 553 error code for IP addresses listed in the RBL.
<li><tt>-C</tt>:
(Default.)
Handle RBL lookups in a ``fail-open'' mode.
If an RBL lookup fails temporarily,
assume that the address is not listed;
if an anti-RBL lookup fails temporarily,
assume that the address is anti-listed.
Unfortunately, a knowledgeable attacker
can force an RBL lookup or an anti-RBL lookup to fail temporarily,
so that his mail is not blocked.
<li><tt>-c</tt>:
Handle RBL lookups in a ``fail-closed'' mode.
If an RBL lookup fails temporarily,
assume that the address is listed
(but use a 451 error code even with <tt>-b</tt>).
If an anti-RBL lookup fails temporarily,
assume that the address is not anti-listed
(but use a 451 error code
even if a subsequent RBL lookup succeeds with <tt>-b</tt>).
Unfortunately, this sometimes delays legitimate mail.
</ul>
</body>
</html>
