<html>
<body>
<a href="../djb.html">D. J. Bernstein</a>
<br><a href="../tcpip.html">TCP/IP</a>
<br><a href="../ucspi-tcp.html">ucspi-tcp</a>
<h1>The <tt>tcpserver</tt> program</h1>
<tt>tcpserver</tt> accepts incoming TCP connections.
<h2>Interface</h2>
<pre>
     tcpserver <i>opts</i> <i>host</i> <i>port</i> <i>prog</i>
</pre>
<tt><i>opts</i></tt>
is a series of <tt>getopt</tt>-style options.
<tt><i>host</i></tt> is one argument.
<tt><i>port</i></tt> is one argument.
<tt><i>prog</i></tt> consists of one or more arguments.
<p>
<tt>tcpserver</tt> waits for connections from TCP clients.
For each connection, it runs <tt><i>prog</i></tt>,
with descriptor 0 reading from the network
and descriptor 1 writing to the network.
It also sets up several
<a href="environment.html">environment variables</a>.
<p>
The server's address is given by <tt><i>host</i></tt> and <tt><i>port</i></tt>.
<tt><i>port</i></tt> may be a name from <tt>/etc/services</tt> or a number;
if it is <tt>0</tt>,
<tt>tcpserver</tt> will choose a free TCP port.
<tt><i>host</i></tt> may be <tt>0</tt>,
allowing connections to any local IP address;
or a dotted-decimal IP address,
allowing connections only to that address;
or a host name,
allowing connections to the <i>first</i> IP address for that host.
Host names are fed through
<a href="../djbdns/qualify.html">qualification</a>
using <tt>dns_ip4_qualify</tt>.
<p>
<tt>tcpserver</tt> exits when it receives SIGTERM.
<h2>Options</h2>
General options:
<ul>
<li><tt>-q</tt>: Quiet. Do not print error messages.
<li><tt>-Q</tt>: (Default.) Print error messages.
<li><tt>-v</tt>: Verbose. Print error messages and status messages.
</ul>
Connection options:
<ul>
<li><tt>-c <i>n</i></tt>:
Do not handle more than <tt><i>n</i></tt> simultaneous connections.
If there are <tt><i>n</i></tt> simultaneous copies of <tt><i>prog</i></tt>
running,
defer acceptance of a new connection until one copy finishes.
<tt><i>n</i></tt> must be a positive integer.
Default: 40.
<li><tt>-x <i>cdb</i></tt>:
Follow the rules compiled into <tt><i>cdb</i></tt> by 
<a href="tcprules.html"><tt>tcprules</tt></a>.
These rules may specify setting environment variables
or rejecting connections from bad sources.
You can rerun <tt>tcprules</tt>
to change the rules while <tt>tcpserver</tt> is running.
<li><tt>-X</tt>:
With <tt>-x <i>cdb</i></tt>,
allow connections even if <tt><i>cdb</i></tt> does not exist.
Normally
<tt>tcpserver</tt> will drop the connection
if <tt><i>cdb</i></tt> does not exist.
<li><tt>-B <i>banner</i></tt>:
Write <tt><i>banner</i></tt> to the network
immediately after each connection is made.
<tt>tcpserver</tt> writes <tt><i>banner</i></tt>
before looking up <tt>$TCPREMOTEHOST</tt>,
before looking up <tt>$TCPREMOTEINFO</tt>,
and before checking <tt><i>cdb</i></tt>.
This feature can be used to reduce latency in protocols
where the client waits for a greeting from the server.
<li><tt>-g <i>gid</i></tt>:
Switch group ID to <tt><i>gid</i></tt> after preparing to receive connections.
<tt><i>gid</i></tt> must be a positive integer.
<li><tt>-u <i>uid</i></tt>:
Switch user ID to <tt><i>uid</i></tt> after preparing to receive connections.
<tt><i>uid</i></tt> must be a positive integer.
<li><tt>-U</tt>: Same as <tt>-g $GID -u $UID</tt>.
Typically <tt>$GID</tt> and <tt>$UID</tt> are set by
<a href="../daemontools/envuidgid.html"><tt>envuidgid</tt></a>.
<li><tt>-1</tt>:
After preparing to receive connections,
print the local port number to standard output.
<li><tt>-b <i>n</i></tt>:
Allow a backlog of approximately <tt><i>n</i></tt> TCP SYNs.
On some systems, <tt><i>n</i></tt> is silently limited to 5.
On systems supporting SYN cookies, the backlog is irrelevant.
<li><tt>-o</tt>: Leave IP options alone.
If the client is sending packets along an IP source route,
send packets back along the same route.
<li><tt>-O</tt>: (Default.) Kill IP options.
A client can still use source routing
to connect and to send data,
but packets will be sent back along the default route.
<li><tt>-d</tt>: Delay sending data for a fraction of a second
whenever the remote host is responding slowly.
This is currently the default, but it may not be in the future;
if you want it, set it explicitly.
<li><tt>-D</tt>: Never delay sending data; enable <tt>TCP_NODELAY</tt>.
</ul>
Data-gathering options:
<ul>
<li><tt>-h</tt>: (Default.)
Look up the remote host name in DNS
to set the environment variable <tt>$TCPREMOTEHOST</tt>.
<li><tt>-H</tt>:
Do not look up the remote host name in DNS;
remove the environment variable <tt>$TCPREMOTEHOST</tt>.
To avoid loops,
you <i>must</i> use this option for servers on TCP port 53.
<li><tt>-p</tt>: Paranoid.
After looking up the remote host name in DNS,
look up the IP addresses in DNS for that host name,
and remove the environment variable <tt>$TCPREMOTEHOST</tt>
if none of the addresses match the client's IP address.
<li><tt>-P</tt>: (Default.) Not paranoid.
<li><tt>-l <i>localname</i></tt>:
Do not look up the local host name in DNS;
use <tt><i>localname</i></tt> for the environment variable <tt>$TCPLOCALHOST</tt>.
A common choice for <tt><i>localname</i></tt> is <tt>0</tt>.
To avoid loops,
you <i>must</i> use this option for servers on TCP port 53.
<li><tt>-r</tt>: (Default.)
Attempt to obtain <tt>$TCPREMOTEINFO</tt> from the remote host.
<li><tt>-R</tt>:
Do not attempt to obtain <tt>$TCPREMOTEINFO</tt> from the remote host.
To avoid loops,
you <i>must</i> use this option for servers on TCP ports 53 and 113.
<li><tt>-t <i>n</i></tt>:
Give up on the <tt>$TCPREMOTEINFO</tt> connection attempt
after <tt><i>n</i></tt> seconds.
Default: 26.
</ul>
</body>
</html>
