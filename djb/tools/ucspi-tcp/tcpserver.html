<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-2022-jp">
<title>The addcr and delcr programs</title>
</head>
<body>
<a href="http://cr.yp.to/djb.html">D. J. Bernstein</a>
<br><a href="http://cr.yp.to/tcpip.html">TCP/IP</a>
<br><a href="top.html">ucspi-tcp</a>
<h1><a href="http://cr.yp.to/ucspi-tcp/tcpserver.html"><tt>tcpserver</tt> プログラム</a></h1>
<tt>tcpserver</tt> は入ってくる TCP 接続を受け付けます。

<h2>使い方</h2>
<pre>
     tcpserver <i>opts</i> <i>host</i> <i>port</i> <i>prog</i>
</pre>
<tt><i>opts</i></tt> は <tt>getopt</tt> 形式のオプション郡です。
<tt><i>host</i></tt> は一つの引数です。
<tt><i>port</i></tt> は一つの引数です。
<tt><i>prog</i></tt> は一つ以上の引数から成ります。

<p>
<tt>tcpserver</tt> は TCP クライアントからの接続を待ちます。
それぞれの接続に対して <tt><i>prog</i></tt> を起動します。
このとき、記述子 0 でネットワークから読み取り、記述子 1 でネットワークへの書き出します。
いくつかの <a href="environment.html">環境変数</a> も設定します。

<p>
サーバのアドレスは <tt><i>host</i></tt> と <tt><i>port</i></tt> により与えられます。
<tt><i>port</i></tt> は <tt>/etc/services</tt> での名前あるいは番号です。
0 であれば、<tt>tcpserver</tt> は空いている TCP ポートを選びます。
<tt><i>host</i></tt> は任意のローカル IP アドレスへの接続を許可する <tt>0</tt> か、そのアドレスのみの接続を許可するドット付き10進表記 IP アドレスか、そのホストの <i>最初の</i> IP アドレスへの接続を許可するホスト名です。
ホスト名は <tt>dns_ip4_qualify</tt> を用いた <a href="http://djbdns.jp.qmail.org/djbdns/qualify.html">限定/修飾(qualification)</a> を通して与えられます。

<p>
tcpserver は SIGTERM を受け取ると終了します。

<h2>オプション</h2>
一般オプション:
<ul>
<li><tt>-q</tt>: 無言モード。エラーメッセージを出力しません。
<li><tt>-Q</tt>: (デフォルト)  エラーメッセージを出力します。
<li><tt>-v</tt>: 多言モード。エラーメッセージとステータスメッセージを出力します。
</ul>

接続オプション:
<ul>
<li><tt>-c <i>n</i></tt>:
<tt><i>n</i></tt> を越えた接続をさせません。
<tt><i>n</i></tt> 個の <tt><i>prog</i></tt> が同時に起動していたら、どれか一つが終了するまで新しい接続を受け付けません。
<tt><i>n</i></tt> は正の正数でなければなりません。
デフォルト: 40。

<li><tt>-x <i>cdb</i></tt>:
<a href="tcprules.html"><tt>tcprules</tt></a> を使って <tt><i>cdb</i></tt> にコンパイルされた規則に従います。
この規則は環境変数を設定や不正な起点からの接続の拒否を指定します。
<tt>tcpserver</tt> が起動していても、tcprules を再実行して規則を変えることができます。

<li><tt>-X</tt>:
オプション <tt>-x <i>cdb</i></tt> と一緒に用いて、<tt><i>cdb</i></tt> が存在しなくても接続を許可します。 
普通、<tt>tcpserver</tt> は <tt><i>cdb</i></tt> が存在しなければ接続を落とします。

<li><tt>-B <i>banner</i></tt>:
接続開始時にネットワークへ <tt><i>banner</i></tt> を書き出します。
<tt>tcpserver</tt> は <tt>$TCPREMOTEHOST</tt> を調べる前に、<tt>$TCPREMOTEINFO</tt> を調べる前に、そして <tt><i>cdb</i></tt> を照合する前に <tt><i>banner</i></tt> を書き出します。
この特徴はクライアントがサーバからの挨拶を待つようなプロトコルでの待ち時間を削減するために使用できます。

<li><tt>-g <i>gid</i></tt>:
接続準備完了時にグループ ID を <tt><i>gid</i></tt> に切り替えます。
<tt><i>gid</i></tt> は正の整数でなければなりません。

<li><tt>-u <i>uid</i></tt>:
接続準備完了時にユーザ ID を <tt><i>uid</i></tt> に切り替えます。
<tt><i>uid</i></tt> は正の整数でなければなりません。

<li><tt>-U</tt>:
<tt>-g $GID -u $UID</tt> と同じ。
例によって <tt>$GID</tt> と <tt>$UID</tt> は <a href="../daemontools/envuidgid.html"><tt>envuidgid</tt></a> を使って設定されます。

<li><tt>-1</tt>:
接続準備完了時に標準出力にローカルポート番号を印字します。

<li><tt>-b <i>n</i></tt>:
おおよそ <tt><i>n</i></tt> 個の TCP SYN のバックログ(backlog)を許します。
システムによっては <tt><i>n</i></tt> は何も言わずに 5 に制限されます。
SYN cookies をサポートしているシステムでは、バックログは無意味です。

<li><tt>-o</tt>:
IP オプションをそのままにしておきます。
クライアントが IP ソースルート指定のパケットを送っていたら、同じルートでパケットを送り返します。（訳者注：セキュリティ上危険なので設定しないでください）
     
<li><tt>-O</tt>: 
(デフォルト) IP オプションを殺します。
クライアントは接続やデータ送信にソースルーティングを使うことができます。
しかし、パケットはデフォルトルートに沿って送り返されるでしょう。

<li><tt>-d</tt>:
リモートホストの返答が遅いときにはデータ送信を遅らせます。
これは今のところデフォルトですが、今後はそうでないかもしれません。
遅らせたいのであれば、はっきりと設定してください。

<li><tt>-D</tt>: 
データ送信を遅らせません。<tt>TCP_NODELAY</tt> を有効にします。
</ul>

データ収集オプション:
<ul>
<li><tt>-h</tt>: (デフォルト)
環境変数 <tt>$TCPREMOTEHOST</tt> を設定するために DNS でリモートホスト名を調べます。

<li><tt>-H</tt>:
DNS でリモートホスト名を調べません。
環境変数 <tt>$TCPREMOTEHOST</tt> を取り除きます。
ループを避けるために、TCP 53番ポートを用いるサーバではこのオプションを使わなければなりません。

<li><tt>-p</tt>: 
パラノイドモード。
DNS でリモートホスト名を検索後、そのホスト名の IP アドレスを DNS で検索します。そのアドレスのどれもクライアントの IP アドレスと一致しなければ、環境変数 <tt>$TCPREMOTEHOST</tt> を取り除きます。

<li><tt>-P</tt>: 
(デフォルト) パラノイドの解除。

<li><tt>-l <i>localname</i></tt>:
DNS でローカルホスト名を調べません。
環境変数 <tt>$TCPLOCALHOST</tt> には <tt><i>localname</i></tt> を使います。
<tt><i>localname</i></tt> の共用選択(common choice)は <tt>0</tt> です。
ループを避けるために、TCP 53番ポートを用いるサーバではこのオプションを使わなければなりません。

<li><tt>-r</tt>: (デフォルト)
リモートホストから <tt>$TCPREMOTEINFO</tt> の取得を試みます。

<li><tt>-R</tt>:
リモートホストから <tt>$TCPREMOTEINFO</tt> の取得を試みません。
ループを避けるために、TCP 53番ポートと113番ポートを用いるサーバではこのオプションを使わなければなりません。

<li><tt>-t <i>n</i></tt>:
<tt><i>n</i></tt> 秒後に <tt>$TCPREMOTEINFO</tt> 接続の試みを諦めます。
デフォルト: 26。

</ul>

<hr>
訳：滝澤 隆史<br>
<!-- hhmts start -->
Last modified: Sun Nov 19 22:19:34 2000
<!-- hhmts end -->
</body>
</html>
