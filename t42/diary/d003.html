<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
<title>Java Mailer T42 Project - diary:003</title>
<meta http-equiv="content-type" content="text/html;charset=iso-2022-jp">
<meta http-equiv="content-style-type" content="text/css">
<link rev="made" href="mailto:taki@cyber.email.ne.jp">
<link rel="stylesheet" href="../../taki.css">
</head>
<body lang="ja">
<h1>Java Mailer T42 Project</h1>
<h2>製作日誌</h2>
<h3>第3回: メッセージの保管形式</h3>
<p>1999年5月24日(1999年6月2日更新)</p>
<hr>
<h4>ポリシー</h4>
<p>メッセージの保管形式に関しては次のポリシーで運用する。</p>
<ul>
<li>1メッセージ 1ファイル。
<li>メッセージは一切改編しない。オリジナルのままとする。
<li>ファイル名はメッセージを保管する時刻のタイムスタンプとする。
<li>ディスクアクセスは極力少なくする。
</ul>

<hr>
<h4>特徴</h4>
<p>このポリシーの長所として思い付くものをあげてみる。</p>
<ul>
<li>何らかの原因でファイルが壊れたとしても被害は極小化できる。
<li>ファイルをロックする必要がない。
<li>振り分けによるメッセージの移動はファイル名の変更のみで済むため高速である。
<li>オリジナルのまま保管しているため、カプセル化して転送する際に扱いやすい。
</ul>

<p>逆に短所と思われるものをあげてみる。</p>
<ul>
<li>ファイルシステムの管理情報を消費する。
<li>クラスタギャップが生じるためディスク容量を無駄に消費する。
</ul>

<p>この短所は大容量のハードディスクが安価に手に入る現在では恐らく問題にならないでしょう。</p>

<hr>
<h4>ファイル名とタイムスタンプ</h4>
<p>タイムスタンプをファイル名にする理由は、ディレクトリ内のファイルリストを取得するオーバーヘッドを省略できるからである。例えばシーケンスナンバーを付けるとどうしてもディレクトリ内のファイルの最終番号を取得する必要が出て来る。特定のファイル内に最終番号を記録するという手もあるが、そのファイルの内容の更新を頻繁に行わなくてはならないし、管理情報ファイルは(ただでさえ多いので)出来るだけ増やしたくないという考えもある。また、ファイルリストの取得して最大値を探すとなると、メッセージ数が数千〜万通になると結構馬鹿にならない。そこで格納する時刻のタイムスタンプをファイル名にすると、これはそのままユニークなファイル名なのでそのまま使うことが出来る。実にシンプルである。</p>
<p>Java では時間の管理の1970年1月1日 00:00:00 UTC(いわゆる Epoch)を起点としたミリ秒で行っている。64ビット(long)であるため将来的にもとりあえず問題は生じない。そういうわけで、最小単位は1ミリ秒であるが、メッセージを取得する間隔がそれ以内であると問題が生じることになる。では、実際はどうかというと、筆者の環境ではあるが、LAN(10Mbps)内ではおよそ200ミリ秒、ISDN 64Kbps ではおよそ1秒であるため問題は生じないと思われる。1ミリ秒以内になるような羨ましい環境にはまず当分ならないだろうと考え、この方針で行うことにする。しかし、マシンの時間がずれていて、それを修正したため、同じタイムスタンプのファイルが既に存在する可能性もある。このときは数値をインクリメントするだけで済ませる。取得間隔が1ミリ秒以内になった場合も同じ動作で処理できるはずである。補助シーケンスナンバーなどを付けるなどで処理も出来ると思うが、それはそのような時代になったときにでも見直すことにする。</p>

<hr>
<h4>インデックス</h4>
<p>高速な動作を行うために、ディスクに対する読み書きを行うのは送受信時およびメッセージの表示時、及び起動/終了時のみとし最小限にとどめる。振り分けなどによるメッセージのディレクトリ間の移動はファイル名の変更で済むため負荷にはならない。このディスクアクセスを最小限にするためにインデックスを作成し、利用する。</p>
<p>インデックスにはリスト画面での表示および振り分け条件に必要なヘッダーの情報を格納し、ファイル名をキーとしたハッシュテーブルとしてメモリ上で運用する。このインデックスは起動時に読み込まれ、メッセージの保管時に追加され、終了時に変更がある場合のみ保存される。何らかの原因で異常終了した場合は、変更があったディレクトリに対してインデックスの再構築を行う。</p>
<p>現状で考えられる問題点としてはメモリ資源を浪費することである。1メッセージ当たり0.5Kバイトのインデックスをメモリに保持するとして、2000メッセージで1Mバイトのメモリが必要になる。メイリングリストにたくさん入っている人なら数万メッセージくらいはすぐに溜るでしょうから、多いに問題になりそうである。再考の余地あり。</p>

<hr>
<a href="index.html">目次</a>
</body>
</html>
